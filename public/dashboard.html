<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace - PowerI.in</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --royal-blue: #003399; --accent-red: #e63946; }
        body { background: #f4f7f9; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Sidebar Styling */
        .forms-sidebar { flex: 1; min-width: 320px; background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 85vh; overflow-y: auto; }
        .dashboard-cat { border-bottom: 1px solid #f0f0f0; }
        .cat-label { width: 100%; text-align: left; padding: 15px; background: none; border: none; font-weight: bold; cursor: pointer; color: #444; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .cat-label:hover { background: #f8f9fa; color: var(--royal-blue); }
        .cat-content { display: none; padding: 10px; background: #fafafa; border-left: 4px solid var(--royal-blue); }
        .form-link { display: block; padding: 10px 15px; text-decoration: none; color: #555; font-size: 0.9rem; transition: 0.3s; border-radius: 4px; }
        .form-link:hover { color: var(--royal-blue); background: #eef2ff; padding-left: 20px; }
        
        /* Table Styling for MongoDB Data */
        .db-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        .db-table th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid var(--royal-blue); color: #333; font-size: 13px; }
        .db-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .btn-view { background: var(--royal-blue); color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.3s; }
        .btn-view:hover { background: #002266; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Scrollbar styling for sidebar */
        .forms-sidebar::-webkit-scrollbar { width: 6px; }
        .forms-sidebar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body>

    <header>
        <nav class="nav-links-container" style="background: var(--royal-blue); padding: 12px 40px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div class="brand-logo" style="font-size: 24px; font-weight: bold; letter-spacing: 1px;">Power<span style="color: #ffeb3b;">I</span>.in</div>
            <ul class="nav-links" style="list-style: none; display: flex; gap: 25px; margin: 0; padding: 0;">
                <li><a href="/index.html" style="color: white; text-decoration: none; font-weight: 500;"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="dashboard.html" style="color: #ffeb3b; text-decoration: none; font-weight: bold;"><i class="fas fa-chart-line"></i> Workspace</a></li>
                <li><a href="community.html" style="color: white; text-decoration: none; font-weight: 500;"><i class="fas fa-users"></i> Community</a></li>
            </ul>
        </nav>
    </header>

    <main style="padding: 25px;">
        <div class="dashboard-header" style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: var(--royal-blue); margin-bottom: 5px; font-size: 28px;">COMPLIANCE MASTER</h2>
            <p style="color: #666; font-style: italic;">Industrial Control Center | Precise Electrical Documentation</p>
        </div>

        <div class="dashboard-workspace" style="display: flex; gap: 25px; max-width: 1500px; margin: 0 auto;">
            
            <aside class="forms-sidebar">
                <div style="background: var(--royal-blue); color: #fff; padding: 18px; font-weight: bold; position: sticky; top: 0; z-index: 10; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-folder-tree"></i> COMPLIANCE SECTIONS
                </div>
                
                <div class="category-stack" style="padding: 10px;">
                    <div class="dashboard-cat">
                        <button class="cat-label" onclick="toggleDashboardCat(this)">1. RETURNS <i class="fas fa-chevron-down"></i></button>
                        <div class="cat-content">
                            <a href="forms/return-letter.html" target="_blank" class="form-link"><strong>Covering Letter for Returns Submission </strong></a>
                            <a href="forms/form-1.html" target="_blank" class="form-link"><strong>Form I </strong>(Monthly Generation & Consumption Return)</a>
                            <a href="forms/form-g.html" target="_blank" class="form-link"><strong>Form G </strong>(Monthly Abstract showing total Energy)</a>
                            <a href="forms/format-A.html" target="_blank" class="form-link"><strong>Format A </strong>(Details of Generation and Consumption for IPP / CPP)</a>
                            <a href="forms/format-B.html" target="_blank" class="form-link"><strong>Format B </strong>(Generating power plant Details)</a>
                            <a href="forms/form-k.html" target="_blank" class="form-link">Form G (Additional)</a>
                        </div>
                    </div>

                    <div class="dashboard-cat">
                        <button class="cat-label" onclick="toggleDashboardCat(this)">2. CEIG / INSPECTORATE <i class="fas fa-chevron-down"></i></button>
                        <div class="cat-content">
                            <a href="forms/drawing-app.html" target="_blank" class="form-link"><strong>Drawing Approval Application</a>
                            <a href="forms/insp-app.html" target="_blank" class="form-link">Application for Inspection</a>
                            <a href="forms/test.html" target="_blank" class="form-link">Site Test Report</a>
                            <a href="forms/form-L.html" target="_blank" class="form-link">Form L</a>
                            <a href="forms/form-A.html" target="_blank" class="form-link">Form A</a>
                            <a href="forms/form-6.html" target="_blank" class="form-link">Form 6</a>
                             <a href="forms/annex-c.html" target="_blank" class="form-link">Annexure-C</a>
                              <a href="forms/form-D.html" target="_blank" class="form-link">Annexure-D</a>
                            <a href="forms/workcompletion.html" target="_blank" class="form-link">Work Completion</a>
                            <a href="forms/self-dec.html" target="_blank" class="form-link">HT supervisour Self Declaration</a>
                            <a href="forms/completionwork.html" target="_blank" class="form-link">Work Completion Certificate</a>
                            <a href="forms/charging-clearance.html" target="_blank" class="form-link">Charging Clearance App</a>
                        </div>
                    </div>

                    <div class="dashboard-cat">
                        <button class="cat-label" onclick="toggleDashboardCat(this)">3. CSPDCL RELATED <i class="fas fa-chevron-down"></i></button>
                        <div class="cat-content">
                            <a href="forms/cspdcl-new.html" target="_blank" class="form-link">New Connection App</a>
                            <a href="forms/line-charging.html" target="_blank" class="form-link">Line Charging App</a>
                            <a href="forms/load-change.html" target="_blank" class="form-link">Load Enhancement/Reduction</a>
                            <a href="forms/line-shifting.html" target="_blank" class="form-link">Line Shifting App</a>
                            <a href="forms/line-shutdown.html" target="_blank" class="form-link">Line Shutdown App</a>
                        </div>
                    </div>

                    <div class="dashboard-cat">
                        <button class="cat-label" onclick="toggleDashboardCat(this)">4. MINES / DGMS <i class="fas fa-chevron-down"></i></button>
                        <div class="cat-content">
                            <a href="forms/form-m.html" target="_blank" class="form-link">Form M</a>
                            <a href="forms/form-h.html" target="_blank" class="form-link">Form H</a>
                            <a href="forms/mine-common.html" target="_blank" class="form-link">Common Application</a>
                        </div>
                    </div>

                    <div class="dashboard-cat">
                        <button class="cat-label" onclick="toggleDashboardCat(this)">5. CEA FORMATS <i class="fas fa-chevron-down"></i></button>
                        <div class="cat-content">
                            <a href="forms/safety.html" target="_blank" class="form-link">Safety Officer appointment</a>
                            <a href="forms/job-format.html" target="_blank" class="form-link">Any Electrical Job Assignment </a>
                        </div>
                    </div>

                    <div class="dashboard-cat">
                        <button class="cat-label" onclick="toggleDashboardCat(this)">6. ISO 50001 FORMATS <i class="fas fa-chevron-down"></i></button>
                        <div class="cat-content">
                            <a href="forms/iso-energy.html" target="_blank" class="form-link">Energy Management Formats</a>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="folder-main" style="flex: 2.5; background: #fff; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 85vh; overflow-y: auto;">
                <h3 style="color: var(--royal-blue); border-bottom: 2px solid #eee; padding-bottom: 15px; margin-top: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-database"></i> My Compliance Vault
                </h3>

                <div id="category-wise-history">
                    <p style="text-align:center; color:#999; margin-top:50px;">
                        <i class="fas fa-spinner fa-spin"></i> Organizing your records from MongoDB...
                    </p>
                </div>
            </main>
        </div>
    </main>

    <script>
    // FUNCTION 1: Toggle Sidebar Categories (Kept as is)
    function toggleDashboardCat(button) {
        const content = button.nextElementSibling;
        const icon = button.querySelector('i');
        
        if (content.style.display === "block") {
            content.style.display = "none";
            icon.className = "fas fa-chevron-down";
        } else {
            document.querySelectorAll('.cat-content').forEach(c => c.style.display = "none");
            document.querySelectorAll('.cat-label i').forEach(i => i.className = "fas fa-chevron-down");
            
            content.style.display = "block";
            icon.className = "fas fa-chevron-up";
        }
    }

    // FUNCTION 2: Load and Categorize Records from MongoDB
    async function loadCategorizedDocs() {
        const container = document.getElementById('category-wise-history');
        const token = localStorage.getItem('token');

        try {
            const response = await fetch('http://localhost:5000/api/my-documents', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if(!response.ok) throw new Error("Server down or Unauthorized");
            
            const allDocs = await response.json();
            container.innerHTML = '';

            const categoryMap = [
                { label: "1. RETURNS", keyword: "RETURNS" },
                { label: "2. CEIG / INSPECTORATE", keyword: "CEIG" },
                { label: "3. CSPDCL RELATED", keyword: "CSPDCL" },
                { label: "4. MINES / DGMS", keyword: "MINE" },
                { label: "5. CEA FORMATS", keyword: "CEA" },
                { label: "6. ISO 50001 FORMATS", keyword: "ISO" },
                { label: "7. ELECTRICAL DUTY", keyword: "DUTY" }
            ];

            let hasAnyData = false;

            categoryMap.forEach(cat => {
                const filteredDocs = allDocs.filter(d => 
                    d.section && d.section.toUpperCase().includes(cat.keyword)
                );
                
                if (filteredDocs.length > 0) {
                    hasAnyData = true;
                    const sectionHTML = `
                        <div style="margin-bottom: 30px;">
                            <h4 style="background:#eef2ff; color:var(--royal-blue); padding:12px; border-radius:6px; margin-bottom:10px; font-size:15px; display:flex; align-items:center; gap:10px;">
                                <i class="fas fa-folder-open"></i> ${cat.label} 
                                <span style="background:var(--royal-blue); color:white; font-size:10px; padding:2px 8px; border-radius:10px; margin-left:auto;">${filteredDocs.length} Files</span>
                            </h4>
                            <table class="db-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Form Name</th>
                                        <th style="text-align:right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredDocs.map(doc => `
                                        <tr id="row-${doc._id}">
                                            <td>${doc.date || new Date(doc.createdAt).toLocaleDateString()}</td>
                                            <td><strong>${doc.formName}</strong></td>
                                            <td style="text-align:right; display: flex; gap: 8px; justify-content: flex-end;">
                                                <button class="btn-view" onclick="openPDF('${doc.pdfFile || ""}')">
                                                    <i class="fas fa-file-pdf"></i> VIEW
                                                </button>
                                                <button onclick="deleteDoc('${doc._id}')" style="background:#ffebee; color:#c62828; border:1px solid #ffcdd2; padding:6px 10px; border-radius:4px; cursor:pointer; font-size:12px;">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML += sectionHTML;
                }
            });

            if (!hasAnyData) {
                container.innerHTML = `<div style="text-align:center; padding:60px 20px; color:#aaa;"><p>No documents found.</p></div>`;
            }
        } catch (e) {
            console.error("Fetch Error:", e);
            container.innerHTML = `<div style="color:red; text-align:center; padding:40px;">Connection Error</div>`;
        }
    }

    // FUNCTION 3: Open PDF
    function openPDF(pdfData) {
        if (!pdfData) { alert("No PDF data found."); return; }
        const win = window.open();
        win.document.write(`<body style="margin:0;"><iframe src="${pdfData}" frameborder="0" style="width:100%; height:100vh;"></iframe></body>`);
    }

    // FUNCTION 4: Delete Document (WITH IMPROVED ERROR LOGGING)
    async function deleteDoc(docId) {
    if (!confirm("Are you sure?")) return;

    const token = localStorage.getItem('token');
    // Switch back to localhost to test resolution
    const url = `http://127.0.0.1:5000/api/documents/${docId}`;

    try {
        const response = await fetch(url, {
            method: 'DELETE',
            headers: { 
                'Authorization': `Bearer ${token}`
            }
        });

        // SAFETY: Check if the response is actually JSON before parsing
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            const data = await response.json();
            if (response.ok) {
                alert("Deleted!");
                document.getElementById(`row-${docId}`).remove();
            } else {
                alert("Server said: " + data.msg);
            }
        } else {
            // If we get here, the server sent HTML (404 page)
            console.error("Received HTML instead of JSON. Route is definitely missing.");
            alert("Error 404: The server doesn't recognize the Delete command. Check route order in server.js");
        }
    } catch (error) {
        alert("Connection failed.");
    }
}

    window.onload = function() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = "index.html";
        } else {
            loadCategorizedDocs();
        }
    };
</script>
</body>
</html>

