<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form G - Complete Bilingual | PowerI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #0b3ba7; --accent: #d62828; --bg: #f5f8ff; --border: #dfe6f7; }
        
        /* Layout Styling */
        body { margin: 0; padding: 0; background: var(--bg); font: 12px/1.4 "Segoe UI", "Noto Sans Devanagari", sans-serif; color: #111; }
        .wrap { max-width: 950px; margin: 15px auto; padding-bottom: 80px; }
        .card { background: #fff; border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        
        header { background: linear-gradient(135deg, var(--primary), #0e49c5); color: #fff; padding: 15px 20px; border-bottom: 4px solid var(--accent); }
        header h1 { margin: 0; font-size: 18px; font-weight: 800; }
        header p { margin: 4px 0 0; font-size: 11px; opacity: 0.9; line-height: 1.3; }

        .brand-strip { display: flex; justify-content: space-between; padding: 8px 20px; background: #f0f4ff; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--primary); }
        
        .section { padding: 12px 20px; border-top: 1px dashed var(--border); }
        .section h2 { margin: 0 0 10px; color: var(--primary); font-size: 14px; font-weight: 800; border-left: 4px solid var(--accent); padding-left: 10px; text-transform: uppercase; }
        
        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
        .col-12 { grid-column: span 12; } .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; }

        label { display: block; font-size: 11px; color: #444; margin-bottom: 2px; font-weight: 600; }
        .blank { width: 100%; border: none; border-bottom: 1px dotted #888; padding: 2px 0; outline: none; font-weight: 600; color: #0b3ba7; background: transparent; font-size: 12px; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 11px; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        th { background: #f8f9fb; color: var(--primary); font-weight: 700; }
        input[type="number"], input[type="text"], select { width: 100%; border: none; outline: none; text-align: center; font-family: inherit; font-size: 11px; background: transparent; }

        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 12px; border-top: 1px solid #ddd; display: flex; justify-content: flex-end; gap: 10px; z-index: 1000; }
        .btn { padding: 8px 18px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn.primary { background: var(--primary); color: white; }
        .btn.accent { background: var(--accent); color: white; }
        .btn.outline { background: #fff; color: var(--primary); border: 1px solid var(--primary); }

        /* ONE-PAGE PRINT OPTIMIZATION */
        @media print {
            @page { size: A4 portrait; margin: 8mm; }
            body { background: white; zoom: 90%; } /* Slight scale to fit all text */
            .bottom-bar, .no-print, button { display: none !important; }
            .card { border: none !important; box-shadow: none !important; }
            .blank { border-bottom: 1px solid #000 !important; color: black !important; }
            th { background: #eee !important; color: #000 !important; }
        }
    </style>
</head>
<body>

<div class="wrap" id="full-form">
    <div class="card">
        <header>
            <h1>Form G [Vide Rule 7(i)] / प्रपत्र-जी [नियम 7(i)]</h1>
            <p>Monthly Abstract showing total units of electrical energy sold or supplied to the distributor or producer, consumed by himself or his employees. / वितरक या उत्पादक को बेची गई तथा स्वयं द्वारा उपभोगित विद्युत ऊर्जा का मासिक सारांश।</p>
        </header>

        <div class="brand-strip">
            <span>....................</span>
            <span>ELECTRICAL DUTY / विद्युत शुल्क</span>
        </div>

        <section class="section">
            <h2>1. Distributor/Producer Details / वितरक विवरण</h2>
            <div class="grid">
                <div class="col-12">
                    <label>Name & Address / नाम व पता</label>
                    <input type="text" class="blank" placeholder="Plant / Industries/company name and Address">
                </div>
                <div class="col-4">
                    <label>Style of Business / व्यवसाय का प्रकार</label>
                    <input type="text" class="blank" placeholder="Captive Power / Industrial">
                </div>
                <div class="col-4">
                    <label>Month Ending / माह समाप्ति</label>
                    <input type="text" id="month_ref" class="blank" placeholder="December 2025">
                </div>
                <div class="col-4">
                    <label>Power Station / विद्युतगृह</label>
                    <input type="text" class="blank" placeholder="Station Name">
                </div>
                <div class="col-6">
                    <label>From Date / दिनांक से</label>
                    <input type="text" class="blank" placeholder="01/12/2025">
                </div>
                <div class="col-6">
                    <label>To Date / दिनांक तक</label>
                    <input type="text" class="blank" placeholder="31/12/2025">
                </div>
            </div>
        </section>

        <section class="section">
            <h2>2. Energy Abstract (KWh/KVAH) / ऊर्जा सारांश</h2>
            <table>
                <thead>
                    <tr>
                        <th>Energy Description / ऊर्जा विवरण</th>
                        <th>KWH Units</th>
                        <th>KVAH Units</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Total Units Generated / कुल उत्पादित ऊर्जा</td>
                        <td><input type="number" step="0.01" class="kwh-input"></td>
                        <td><input type="number" step="0.01"></td>
                    </tr>
                    <tr>
                        <td>Total Units Purchased / कुल खरीदी गई ऊर्जा</td>
                        <td><input type="number" step="0.01" class="kwh-input"></td>
                        <td><input type="number" step="0.01"></td>
                    </tr>
                    <tr>
                        <td><strong>Total (Generated + Purchased) / कुल योग</strong></td>
                        <td><input type="number" id="total_kwh" readonly style="font-weight:bold;"></td>
                        <td><input type="number" readonly></td>
                    </tr>
                    <tr>
                        <td>Dutyable Units @ 20% (Self Consumption) / शुल्क योग्य इकाइयां</td>
                        <td><input type="number"></td>
                        <td><input type="number"></td>
                    </tr>
                </tbody>
            </table>
            <div style="margin-top:8px;">
                <strong>Total ED Amount Payable (₹) / देय शुल्क:</strong> 
                <span style="display:inline-block; width:150px;"><input type="number" class="blank"></span>
            </div>
        </section>

        <section class="section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>3. Generating Sets Details / जनरेटिंग सेट का विवरण</h2>
                <button class="btn outline no-print" onclick="addGenRow()" style="padding:2px 8px; font-size:10px;">+ Add Set</button>
            </div>
            <table id="gen_table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Serial No.</th>
                        <th>Capacity</th>
                        <th>Initial Rdg.</th>
                        <th>Final Rdg.</th>
                        <th>Difference</th>
                        <th>MF</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><select><option>DG</option><option>TG</option><option>Solar</option></select></td>
                        <td><input type="text" placeholder="Add Name"></td>
                        <td><input type="text" placeholder="Add KVA"></td>
                        <td><input type="number" class="init" value="0.00"></td>
                        <td><input type="number" class="final" value="0.00"></td>
                        <td><input type="number" class="diff" value="0.00"></td>
                        <td><input type="number" value="1.0"></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section class="section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>4. Challan Details / चालान का विवरण</h2>
                <button class="btn outline no-print" onclick="addChallanRow()" style="padding:2px 8px; font-size:10px;">+ Add Challan</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Purpose / प्रयोजन</th>
                        <th>Amount (₹) / राशि</th>
                        <th>Challan No / क्रमांक</th>
                        <th>Date / दिनांक</th>
                    </tr>
                </thead>
                <tbody id="challan_body">
                    <tr>
                        <td><select><option>Electrical Duty</option><option>Inspection Fee</option></select></td>
                        <td><input type="number"></td>
                        <td><input type="text"></td>
                        <td><input type="date"></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section class="section" style="border:none;">
            <div class="grid">
                <div class="col-6">
                    <label>Designation / पद</label>
                    <input type="text" class="blank" value="HOD E&I" placeholder="Delete & Add">
                </div>
                <div class="col-6">
                    <label>Authorized Signatory / अधिकृत हस्ताक्षरकर्ता</label>
                    <input type="text" placeholder="Add Name" class="blank">
                </div>
            </div>
            <p style="font-size:13px; color:#666; margin-top:10px;">I hereby declare that the particulars given above are correct. / मैं घोषणा करता हूँ कि उपर्युक्त विवरण सत्य हैं।</p>
        </section>
    </div>
    <div style="text-align: center; font-size: 9px; color: #999; margin-top: 15px;">
                Computer Generated Return via www.poweri.in Dashboard
            </div>
</div>

<div class="bottom-bar">
    <button class="btn outline" onclick="calculateAll()">Calculate / गणना करें</button>
    <button class="btn accent" onclick="saveToMongo()">Save PDF at folder</button>
    <button class="btn primary" onclick="window.print()">Print / Download</button>
</div>

<script>
    function addGenRow() {
        const table = document.getElementById('gen_table').getElementsByTagName('tbody')[0];
        const row = table.insertRow();
        row.innerHTML = `<td><select><option>DG</option><option>TG</option></select></td><td><input type="text"></td><td><input type="text"></td><td><input type="number" class="init" value="0"></td><td><input type="number" class="final" value="0"></td><td><input type="number" class="diff" readonly></td><td><input type="number" value="1.0"></td>`;
    }

    function addChallanRow() {
        const body = document.getElementById('challan_body');
        const row = body.insertRow();
        row.innerHTML = `<td><select><option>Electrical Duty</option></select></td><td><input type="number"></td><td><input type="text"></td><td><input type="date"></td>`;
    }

    function calculateAll() {
        // Calculate Meter Diff
        document.querySelectorAll('#gen_table tbody tr').forEach(row => {
            const i = parseFloat(row.querySelector('.init').value) || 0;
            const f = parseFloat(row.querySelector('.final').value) || 0;
            row.querySelector('.diff').value = (f - i).toFixed(2);
        });
        
        // Calculate Total Energy
        let total = 0;
        document.querySelectorAll('.kwh-input').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('total_kwh').value = total.toFixed(2);
        alert("Calculations completed.");
    }

    async function saveToMongo() {
        calculateAll();
        const element = document.getElementById('full-form');
        const opt = {
            margin: 5,
            filename: 'Form_G_Complete.pdf',
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
        const reader = new FileReader();
        reader.readAsDataURL(pdfBlob);
        reader.onloadend = async () => {
            const response = await fetch('http://localhost:5000/api/save-document', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    section: "ELECTRICAL DUTY",
                    formName: "Form_G_Bilingual.pdf",
                    pdfFile: reader.result,
                    date: document.getElementById('month_ref').value || "Current"
                })
            });
            if (response.ok) alert("Full Document saved to MongoDB!");
        };
    }
</script>
</body>
</html>
