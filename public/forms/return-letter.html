<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covering Letter - PowerI.in</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --royal-blue: #003399; --accent-red: #e63946; }

        /* Added the * here to fix the issue */
* { 
    box-sizing: border-box; 
    -webkit-print-color-adjust: exact; print-color-adjust: exact; 
}
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: #cbd5e0; 
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; 
        }

        .nav-header { 
            background: var(--royal-blue); padding: 10px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            color: white; width: 100%; position: sticky; top: 0; z-index: 100;
        }

        /* WRAPPER TO PREVENT OVERFLOW */
        #pdf-area { 
            background: white; 
            width: 210mm; 
            height: 296mm; /* 1mm shorter than A4 to force single page */
            padding: 45mm 20mm 15mm 20mm; /* 45mm Top Margin */
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden; /* ABSOLUTELY NO OVERFLOW */
            font-family: "Times New Roman", serif;
            font-size: 15px;
            line-height: 1.3;
            color: #000;
        }

        .header-row { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; }
        .input-line { border: none; border-bottom: 1px solid #888; outline: none; font-family: inherit; font-size: 15px; color: #003399; background: transparent; }
        .subject { text-align: center; font-weight: bold; text-decoration: underline; margin: 15px 0; text-transform: uppercase; }
        
        /* CC SECTION PINNED TO BOTTOM */
        
        .bottom-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #fff; padding: 12px 40px; 
            border-top: 2px solid #ddd; display: flex; justify-content: flex-end; gap: 15px; z-index: 1000; 
        }

        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .btn.blue { background: #003399; color: white; }
        .btn.red { background: #e63946; color: white; }
        .btn.gray { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e0; }

        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; }
            .nav-header, .bottom-bar { display: none !important; }
            #pdf-area { margin: 0; box-shadow: none; height: 279mm; }
        }
    </style>
</head>
<body>

    <div class="nav-header">
        <span style="font-weight: bold;">PowerI.in Compliance</span>
        <span style="font-size: 12px;">Covering Letter (1-Page Mode)</span>
    </div>

    <div id="pdf-area">
        
        <div class="header-row">
            <div>Ref: <input type="text" class="input-line" style="width: 160px;" placeholder="REF/001"></div>
            <div>Date: <input type="date"></div>
        </div>

        <div style="margin-bottom: 20px;">
            <strong>To,</strong><br>
            The Chief Electrical Inspector,<br>
            Government of Chhattisgarh,<br>
            Indravati Bhavan, New Raipur (C.G.)
        </div>

        <div class="subject">Subject: Deposit of Electricity Generation Duty</div>

        <div class="content">
            <p>Dear Sir,</p>
            <p>We are enclosing herewith 
                <label><input type="checkbox" checked> Form 'G',</label>
                <label><input type="checkbox" checked> Form 'I',</label>
                <label><input type="checkbox"> Form 'A',</label>
                <label><input type="checkbox"> Form 'B'</label>
                detailing the electricity generated at our plant site during the month of 
                <strong><input type="text" id="month_val" class="input-line" placeholder="Month-YYYY" style="width: 110px; text-align: center;"></strong>.
            </p>

            <p style="text-align: justify;">
                The total electricity generation duty of 
                <strong>Rs. <input type="text" class="input-line" style="width: 120px;"></strong> 
                (Rupees <input type="text" class="input-line" style="width: 350px;"> Only) 
                has been deposited via Echallan No. <strong><input type="text" class="input-line" style="width: 160px;"></strong> 
                dated <strong><input type="text" class="input-line" style="width: 110px;"></strong>. Original challan is attached.
            </p>

            <p>This is for your kind information and necessary action please.</p>
            <p>Thanking you.</p>
        </div>

        <div style="margin-top: 20px;">
            <p>Yours faithfully,</p>
            <div style="margin-top: 15px;">
                <strong>For, <input type="text" class="input-line" placeholder="COMPANY NAME" style="width: 320px; font-weight: bold; text-transform: uppercase;"></strong><br><br><br>
                <span>(Authorized Signatory)</span>
            </div>
            <div style="margin-top: 30px;"> 
            <strong>Copy To:</strong><br>
            1. The Executive Engineer (ES)-cum-Electrical Inspector, Govt. of CG.<input type="text" placeholder="Address"class="input-line" style="width: 120px;"><br>
            2. The Asst. Engineer (ES)-cum-Asst. Electrical Inspector, Govt. of CG.<input type="text" placeholder="Address"class="input-line" style="width: 120px;">
        </div>
        <div style="text-align: center; font-size: 9px; color: #999; margin-top: 15px;">
                Computer Generated Return via www.poweri.in
            </div>
        </div>

        
    </div>

    <div class="bottom-bar">
        <button class="btn gray" onclick="window.location.href='../Dashboard.html'">Dashboard</button>
        <button class="btn red" onclick="saveToMongo()">Save to Folder</button>
        <button class="btn blue" onclick="window.print()">Print Letter</button>
    </div>

    <script>
        async function saveToMongo() {
            const btn = document.querySelector('.btn.red');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            const element = document.getElementById('pdf-area');
            
            const opt = {
                margin: 0,
                filename: 'Covering_Letter.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    y: 0 
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
                const reader = new FileReader();
                reader.readAsDataURL(pdfBlob);
                reader.onloadend = async () => {
                    const response = await fetch('http://localhost:5000/api/save-document', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            section: "ELECTRICAL DUTY",
                            formName: "Covering_Letter.pdf",
                            pdfFile: reader.result,
                            date: document.getElementById('month_val').value || "Current"
                        })
                    });

                    if (response.ok) alert("âœ… Document saved successfully!");
                    btn.innerHTML = 'Save to Folder';
                };
            } catch (err) {
                alert("Error saving PDF.");
                btn.innerHTML = 'Save to Folder';
            }
        }
    </script>
</body>
</html>
